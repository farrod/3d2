<!DOCTYPE html>
<html>
<head>
    <title>3D Model Viewer with Shader LUT</title>
    <style>
        /* ... [Previous CSS remains the same] ... */
    </style>
</head>
<body>
    <div id="controls-panel">
        <!-- ... [Previous controls HTML remains the same] ... -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <script>
        let scene, camera, renderer, controls, currentModel;
        let ambientLight, directionalLight;
        let composer, lutPass;
        let lutTexture = null;
        let lutMixValue = 1.0;

        // Custom shader for LUT application
        const LUTShader = {
            uniforms: {
                "tDiffuse": { value: null },
                "lutMap": { value: null },
                "lutSize": { value: 32.0 },
                "intensity": { value: 1.0 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform sampler2D lutMap;
                uniform float lutSize;
                uniform float intensity;
                varying vec2 vUv;

                void main() {
                    vec4 originalColor = texture2D(tDiffuse, vUv);
                    
                    float cell = lutSize - 1.0;
                    
                    float blueColor = originalColor.b * cell;
                    float row = floor(blueColor);
                    float col = blueColor - row;
                    
                    vec2 quad1 = vec2(0.0);
                    quad1.y = row / lutSize;
                    quad1.x = originalColor.r;
                    
                    vec2 quad2 = vec2(0.0);
                    quad2.y = (row + 1.0) / lutSize;
                    quad2.x = originalColor.r;
                    
                    vec3 newColor1 = texture2D(lutMap, quad1).rgb;
                    vec3 newColor2 = texture2D(lutMap, quad2).rgb;
                    vec3 newColor = mix(newColor1, newColor2, col);
                    
                    gl_FragColor = vec4(mix(originalColor.rgb, newColor, intensity), originalColor.a);
                }
            `
        };

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1, 3);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.body.appendChild(renderer.domElement);

            // Post-processing setup
            composer = new THREE.EffectComposer(renderer);
            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);

            // Create LUT pass
            lutPass = new THREE.ShaderPass(LUTShader);
            lutPass.enabled = false;
            composer.addPass(lutPass);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Lights
            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            setupListeners();
            animate();
        }

        function loadLUT(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                const lutSize = 32;
                const lutData = new Uint8Array(lutSize * lutSize * 3);
                
                let dataIndex = 0;
                for (let line of lines) {
                    line = line.trim();
                    if (line && !line.startsWith('#')) {
                        const [r, g, b] = line.split(' ').map(v => parseFloat(v));
                        lutData[dataIndex] = r * 255;
                        lutData[dataIndex + 1] = g * 255;
                        lutData[dataIndex + 2] = b * 255;
                        dataIndex += 3;
                    }
                }

                lutTexture = new THREE.DataTexture(lutData, lutSize, lutSize, THREE.RGBFormat);
                lutTexture.needsUpdate = true;

                // Update shader uniforms
                lutPass.uniforms.lutMap.value = lutTexture;
                lutPass.uniforms.lutSize.value = lutSize;
                lutPass.enabled = true;

                showMessage('LUT loaded successfully!', '#009933');
            };
            reader.readAsText(file);
        }

        function setupListeners() {
            // ... [Previous listeners remain the same] ...
            
            document.getElementById('lut-mix').addEventListener('input', e => {
                lutMixValue = parseFloat(e.target.value);
                if (lutPass) {
                    lutPass.uniforms.intensity.value = lutMixValue;
                }
                e.target.nextElementSibling.textContent = lutMixValue.toFixed(2);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            composer.render();
        }

        // ... [Rest of the utility functions remain the same] ...

        init();
    </script>
</body>
</html>
